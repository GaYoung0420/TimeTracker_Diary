# AI 회고 기능 가이드

## 개요
Claude AI를 사용한 일일 회고 자동 생성 기능입니다. 당일의 이벤트, 루틴, 할일, 카테고리 시간 데이터를 분석하여 개인화된 회고를 생성합니다.

## 설치 및 설정

### 1. 백엔드 패키지 설치
```bash
cd backend
npm install @anthropic-ai/sdk
```

### 2. 환경 변수 설정
`backend/.env` 파일에 다음을 추가:

```bash
ANTHROPIC_API_KEY=your_anthropic_api_key_here
```

API 키는 [Anthropic Console](https://console.anthropic.com/)에서 발급받을 수 있습니다.

### 3. 서버 재시작
```bash
cd backend
npm run dev
```

## 사용 방법

### 프론트엔드에서 사용하기

1. Daily View의 회고 섹션으로 이동
2. "🤖 AI 회고" 버튼 클릭
3. AI가 생성한 회고 확인
4. "추가하기" 버튼으로 본문에 추가하거나, 직접 수정 가능

## 프롬프트 구조

### 포함되는 데이터

1. **날짜 정보**
   - 날짜 및 요일

2. **당일 이벤트**
   - 실제 수행한 활동 (is_plan=false, is_sleep=false)
   - 시작/종료 시간, 소요 시간
   - 카테고리 및 메모

3. **카테고리별 시간 통계**
   - 각 카테고리별 총 시간
   - 전체 활동 대비 비율
   - 시간 순 정렬

4. **루틴 달성 현황**
   - 각 루틴의 완료/미완료 상태
   - 목표 시간 (설정된 경우)
   - 전체 달성률

5. **할일 완료 현황**
   - 완료/미완료 상태
   - 카테고리
   - 예상 소요 시간
   - 뽀모도로 카운트
   - 전체 완료율

6. **기분**
   - Good/SoSo/Bad 상태

7. **사용자 작성 회고**
   - 기존에 작성한 회고 텍스트 (있는 경우)

### AI 응답 스타일

- 친근하고 격려하는 톤 (반말 사용)
- 구체적인 숫자와 데이터 인용
- 실행 가능한 제안 제공
- 250-350자 내외
- 불필요한 꾸밈말 없이 진솔하게

### 응답 포함 요소

1. **오늘의 하이라이트**: 가장 의미있었던 활동이나 성취
2. **시간 사용 분석**: 카테고리별 시간 배분 피드백
3. **루틴 & 할일 피드백**: 달성에 대한 칭찬, 미달성에 대한 격려
4. **개선 제안**: 내일 더 나아질 수 있는 구체적인 방법 1-2가지
5. **감정 공감**: 기분을 반영한 응원 메시지

## 기술 스택

### 백엔드
- **AI Service**: `backend/src/services/aiService.js`
  - Anthropic SDK 사용
  - Claude 3.5 Sonnet 모델
  - 온도: 0.7

- **프롬프트 빌더**: `backend/src/utils/promptBuilder.js`
  - 이벤트 시간 계산
  - 카테고리 통계 집계
  - 프롬프트 문자열 생성

- **API 엔드포인트**: `backend/src/ai-api.js`
  - `POST /api/ai/daily-reflection`
  - 인증 필요 (requireAuth 미들웨어)
  - 요청: `{ date: 'YYYY-MM-DD' }`
  - 응답: `{ success: true, reflection: "AI 회고 텍스트" }`

### 프론트엔드
- **컴포넌트**: `frontend/src/components/Daily/Reflection.jsx`
  - AI 회고 생성 버튼
  - 로딩 상태 관리
  - 생성된 회고 프리뷰
  - 회고 추가/수정 기능

## API 엔드포인트

### POST /api/ai/daily-reflection

**요청**
```json
{
  "date": "2024-01-06"
}
```

**응답 (성공)**
```json
{
  "success": true,
  "reflection": "오늘 하루도 수고했어! 학습에 4시간 30분을 투자했는데, 전체 활동의 52.9%를 차지했네. React 공부에 집중한 게 눈에 띄어. 아침 운동 루틴도 완료했고, 할일 완료율이 75%나 되니까 정말 잘했어! 내일은 나머지 25%를 완료하는 데 집중해보는 건 어때? 오늘 기분도 좋다고 했으니 이 에너지를 내일로 이어가보자!"
}
```

**응답 (실패)**
```json
{
  "error": "AI 회고 생성 중 오류가 발생했습니다",
  "details": "오류 상세 (개발 환경에서만)"
}
```

## 비용 최적화

- **모델**: Claude 3.5 Sonnet (가성비 좋음)
- **토큰 제한**: 최대 1024 토큰 (약 300-400자)
- **프롬프트 최적화**: 불필요한 데이터 제외 (수면, 계획)

### 예상 비용 (2024년 1월 기준)
- 입력: ~500 토큰 × $3/1M = $0.0015
- 출력: ~300 토큰 × $15/1M = $0.0045
- **회고당 약 $0.006 (약 8원)**

## 향후 개선 방향

### 주간 인사이트 (계획)
```javascript
// backend/src/utils/promptBuilder.js
export function buildWeeklyInsightPrompt(weekData) {
  // 7일간 데이터 분석
  // 트렌드, 패턴, 개선점 제안
}
```

### 추가 기능 아이디어
1. **기분-활동 상관관계 분석**
   - "운동한 날은 기분이 좋았어요"

2. **목표 달성률 추적**
   - 주간/월간 루틴 달성 추세

3. **카테고리 밸런스 제안**
   - "휴식 시간이 부족해 보여요"

4. **사용자 맞춤 스타일**
   - 응원형 vs 분석형 vs 코칭형

## 문제 해결

### API 키 오류
```
Error: ANTHROPIC_API_KEY가 설정되지 않았습니다
```
→ `.env` 파일 확인 및 서버 재시작

### 응답 느림
- Claude API는 일반적으로 2-5초 소요
- 프론트엔드에 로딩 스피너 표시됨

### 회고가 너무 길거나 짧음
- `backend/src/services/aiService.js`의 `max_tokens` 조정
- 프롬프트의 "250-350자 내외" 가이드 수정

## 라이센스 및 주의사항

- Anthropic API 이용약관 준수
- 개인 데이터 처리 시 프라이버시 정책 확인
- API 키는 절대 공개 저장소에 커밋하지 말 것
